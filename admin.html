<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <style>
    /* General Styles */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f0f8ff;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #28a745;
      padding: 10px;
      color: white;
    }

    .settings-dropdown {
      position: relative;
    }

    .settings-btn {
      background: transparent;
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      background: white;
      border: 1px solid #ddd;
      min-width: 120px;
      z-index: 100;
    }

    .settings-btn:hover + .dropdown-content,
    .dropdown-content:hover {
      display: block;
    }

    .dropdown-content a {
      text-decoration: none;
      color: black;
      display: block;
      padding: 10px;
    }

    .section {
      margin: 20px;
      padding: 20px;
      border: 1px solid #ccc;
      background: #fff;
      border-radius: 8px;
    }

    .section h2 {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .badge {
      background: red;
      color: white;
      padding: 5px 10px;
      border-radius: 10px;
      font-size: 14px;
    }

    button {
      margin: 5px;
      padding: 5px 10px;
      background: #28a745;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
    }

    button:hover {
      background: #218838;
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <header>
      <h1>Admin Dashboard</h1>
      <div class="settings-dropdown">
        <button class="settings-btn">Settings</button>
        <div class="dropdown-content">
          <a href="adminprofile.html">Admin Profile</a>
          <a href="#" id="logout">Log Out</a>
        </div>
      </div>
    </header>

    <!-- Sections -->
    <section id="approvalRequests" class="section">
      <h2>Approval Requests <span id="approvalBadge" class="badge">0</span></h2>
      <div class="content">Loading...</div>
    </section>

    <section id="onlineUsers" class="section">
      <h2>Online Users <span id="onlineBadge" class="badge">0</span></h2>
      <div class="content">Loading...</div>
    </section>

    <section id="userLogs" class="section">
      <h2>User Logs <span id="logsBadge" class="badge">0</span></h2>
      <div class="content">Loading...</div>
    </section>

    <section id="approvedUsers" class="section">
      <h2>Approved Users <span id="approvedBadge" class="badge">0</span></h2>
      <div class="content">Loading...</div>
    </section>

    <section id="holdBlockedUsers" class="section">
      <h2>Hold/Blocked Users <span id="holdBlockedBadge" class="badge">0</span></h2>
      <div class="content">Loading...</div>
    </section>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js"></script>
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAXZgxM6PU-T3D2811KnBszblRWju7rv1Y",
      authDomain: "dws-management.firebaseapp.com",
      projectId: "dws-management",
      storageBucket: "dws-management.firebasestorage.app",
      messagingSenderId: "23827231923",
      appId: "1:23827231923:web:97141b6d19c7cd109d2cc6",
      measurementId: "G-L14GLJDYW7"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Real-time loading functions
    document.addEventListener("DOMContentLoaded", () => {
      loadApprovalRequests();
      loadOnlineUsers();
      loadUserLogs();
      loadApprovedUsers();
      loadHoldBlockedUsers();

      document.getElementById("logout").addEventListener("click", () => {
        firebase.auth().signOut().then(() => {
          window.location.href = "index.html";
        });
      });
    });

    function loadApprovalRequests() {
      db.collection("Users")
        .where("isApproved", "==", false)
        .onSnapshot((snapshot) => {
          const badge = document.getElementById("approvalBadge");
          const content = document.getElementById("approvalRequests").querySelector(".content");
          badge.textContent = snapshot.size;
          content.innerHTML = snapshot.size
            ? snapshot.docs.map(doc => `
              <div>${doc.data().username}
                <button onclick="approveUser('${doc.id}')">Approve</button>
                <button onclick="deleteUser('${doc.id}')">Reject</button>
              </div>`).join("")
            : "No approval requests found.";
        });
    }

    function loadOnlineUsers() {
      db.collection("Users")
        .where("isOnline", "==", true)
        .onSnapshot((snapshot) => {
          const badge = document.getElementById("onlineBadge");
          const content = document.getElementById("onlineUsers").querySelector(".content");
          badge.textContent = snapshot.size;
          content.innerHTML = snapshot.size
            ? snapshot.docs.map(doc => `
              <div>${doc.data().username} - Online for ${getTimeDifference(doc.data().lastLogin)}</div>`).join("")
            : "No users online.";
        });
    }

    function loadUserLogs() {
      db.collection("Logs")
        .orderBy("timestamp", "desc")
        .onSnapshot((snapshot) => {
          const badge = document.getElementById("logsBadge");
          const content = document.getElementById("userLogs").querySelector(".content");
          badge.textContent = snapshot.size;
          content.innerHTML = snapshot.size
            ? snapshot.docs.map(doc => `<div>${doc.data().activity} at ${doc.data().timestamp}</div>`).join("")
            : "No logs found.";
        });
    }

    function loadApprovedUsers() {
      db.collection("Users")
        .where("isApproved", "==", true)
        .onSnapshot((snapshot) => {
          const badge = document.getElementById("approvedBadge");
          const content = document.getElementById("approvedUsers").querySelector(".content");
          badge.textContent = snapshot.size;
          content.innerHTML = snapshot.size
            ? snapshot.docs.map(doc => `
              <div>${doc.data().username}
                <button onclick="updateStatus('${doc.id}', 'Hold')">Hold</button>
                <button onclick="updateStatus('${doc.id}', 'Block')">Block</button>
                <button onclick="deleteUser('${doc.id}')">Remove</button>
              </div>`).join("")
            : "No approved users found.";
        });
    }

    function loadHoldBlockedUsers() {
      db.collection("Users")
        .where("status", "in", ["Hold", "Blocked"])
        .onSnapshot((snapshot) => {
          const badge = document.getElementById("holdBlockedBadge");
          const content = document.getElementById("holdBlockedUsers").querySelector(".content");
          badge.textContent = snapshot.size;
          content.innerHTML = snapshot.size
            ? snapshot.docs.map(doc => `
              <div>${doc.data().username} - ${doc.data().status}
                <button onclick="updateStatus('${doc.id}', '')">Unblock</button>
              </div>`).join("")
            : "No hold/blocked users found.";
        });
    }

    function approveUser(userId) {
      db.collection("Users").doc(userId).update({ isApproved: true });
    }

    function updateStatus(userId, status) {
      db.collection("Users").doc(userId).update({ status });
    }

    function deleteUser(userId) {
      db.collection("Users").doc(userId).delete();
    }

    function getTimeDifference(lastLogin) {
      const now = new Date();
      const loginTime = new Date(lastLogin);
      const diffInMs = now - loginTime;
      const diffInHours = Math.floor(diffInMs / (1000 * 60 * 60));
      return `${diffInHours} hours ago`;
    }
  </script>
</body>
</html>