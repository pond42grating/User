<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .section {
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
            padding: 10px;
        }
        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .badge {
            background-color: red;
            color: white;
            border-radius: 50%;
            padding: 3px 8px;
        }
        .section-content {
            display: none;
        }
        .btn {
            padding: 5px 10px;
            margin: 5px;
            border: none;
            border-radius: 3px;
            color: white;
            cursor: pointer;
        }
        .btn-hold { background-color: orange; }
        .btn-block { background-color: red; }
        .btn-remove { background-color: grey; }
        .btn-approve { background-color: green; }
        .btn-reject { background-color: red; }
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: #f9f9f9;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
        }
        .dropdown-content a {
            color: black;
            padding: 8px 16px;
            text-decoration: none;
            display: block;
        }
        .dropdown-content a:hover {
            background-color: #ddd;
        }
        .dropdown:hover .dropdown-content {
            display: block;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getFirestore, doc, getDocs, updateDoc, collection, query, where, arrayUnion, deleteDoc } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAXZgxM6PU-T3D2811KnBszblRWju7rv1Y",
            authDomain: "dws-management.firebaseapp.com",
            projectId: "dws-management",
            storageBucket: "dws-management.firebasestorage.app",
            messagingSenderId: "23827231923",
            appId: "1:23827231923:web:97141b6d19c7cd109d2cc6",
            measurementId: "G-L14GLJDYW7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        document.addEventListener("DOMContentLoaded", async () => {
            const approvalRequests = document.getElementById("approval-requests");
            const onlineUsers = document.getElementById("online-users");
            const userLogs = document.getElementById("user-logs");
            const approvedUsers = document.getElementById("approved-users");
            const holdBlockedUsers = document.getElementById("hold-blocked-users");

            const toggleSections = document.querySelectorAll(".section-title");
            toggleSections.forEach(toggle => {
                toggle.addEventListener("click", () => {
                    const content = toggle.nextElementSibling;
                    content.style.display = content.style.display === "block" ? "none" : "block";
                });
            });

            async function fetchApprovalRequests() {
                const querySnapshot = await getDocs(query(collection(db, "Users"), where("status", "==", "pending")));
                approvalRequests.innerHTML = querySnapshot.empty ? "No approval requests." : "";
                querySnapshot.forEach(doc => {
                    const user = doc.data();
                    const userDiv = document.createElement("div");
                    userDiv.innerHTML = `
                        ${user.username} (${user.email})
                        <button class="btn btn-approve" onclick="approveUser('${doc.id}')">Approve</button>
                        <button class="btn btn-reject" onclick="rejectUser('${doc.id}')">Reject</button>
                    `;
                    approvalRequests.appendChild(userDiv);
                });
            }

            async function fetchOnlineUsers() {
                const querySnapshot = await getDocs(query(collection(db, "Users"), where("isOnline", "==", true)));
                onlineUsers.innerHTML = querySnapshot.empty ? "No online users." : "";
                querySnapshot.forEach(doc => {
                    const user = doc.data();
                    const duration = Math.floor((Date.now() - new Date(user.lastLogin)) / (1000 * 60 * 60));
                    const userDiv = document.createElement("div");
                    userDiv.textContent = `${user.username} (${user.email}) - ${duration} hours online`;
                    onlineUsers.appendChild(userDiv);
                });
            }

            async function fetchUserLogs() {
                const querySnapshot = await getDocs(collection(db, "Logs"));
                userLogs.innerHTML = querySnapshot.empty ? "No logs found." : "";
                querySnapshot.forEach(doc => {
                    const log = doc.data();
                    const logDiv = document.createElement("div");
                    logDiv.textContent = `${log.activity} by ${log.username} at ${new Date(log.timestamp).toLocaleString()}`;
                    userLogs.appendChild(logDiv);
                });
            }

            async function fetchApprovedUsers() {
                const querySnapshot = await getDocs(query(collection(db, "Users"), where("status", "==", "approved")));
                approvedUsers.innerHTML = querySnapshot.empty ? "No approved users." : "";
                querySnapshot.forEach(doc => {
                    const user = doc.data();
                    const userDiv = document.createElement("div");
                    userDiv.innerHTML = `
                        ${user.username} (${user.email})
                        <button class="btn btn-hold" onclick="holdUser('${doc.id}')">Hold</button>
                        <button class="btn btn-block" onclick="blockUser('${doc.id}')">Block</button>
                        <button class="btn btn-remove" onclick="removeUser('${doc.id}')">Remove</button>
                    `;
                    approvedUsers.appendChild(userDiv);
                });
            }

            async function fetchHoldBlockedUsers() {
                const querySnapshot = await getDocs(query(collection(db, "Users"), where("status", "in", ["hold", "block"])));
                holdBlockedUsers.innerHTML = querySnapshot.empty ? "No hold/blocked users." : "";
                querySnapshot.forEach(doc => {
                    const user = doc.data();
                    const status = user.status.charAt(0).toUpperCase() + user.status.slice(1);
                    const userDiv = document.createElement("div");
                    userDiv.innerHTML = `
                        ${user.username} (${user.email}) - ${status}
                        <button class="btn btn-hold" onclick="unholdUser('${doc.id}')">Unhold</button>
                        <button class="btn btn-block" onclick="unblockUser('${doc.id}')">Unblock</button>
                        <button class="btn btn-remove" onclick="removeUser('${doc.id}')">Delete</button>
                    `;
                    holdBlockedUsers.appendChild(userDiv);
                });
            }

            // Approve user
            window.approveUser = async (id) => {
                await updateDoc(doc(db, "Users", id), { status: "approved" });
                fetchApprovalRequests();
                fetchApprovedUsers();
            };

            // Reject user
            window.rejectUser = async (id) => {
                await deleteDoc(doc(db, "Users", id));
                fetchApprovalRequests();
            };

            // Hold user
            window.holdUser = async (id) => {
                await updateDoc(doc(db, "Users", id), {
                    status: "hold",
                    holdTimestamp: new Date().toISOString()
                });
                fetchApprovedUsers();
                fetchHoldBlockedUsers();
            };

            // Block user
            window.blockUser = async (id) => {
                await updateDoc(doc(db, "Users", id), {
                    status: "block",
                    blockTimestamp: new Date().toISOString()
                });
                fetchApprovedUsers();
                fetchHoldBlockedUsers();
            };

            // Remove user
            window.removeUser = async (id) => {
                await deleteDoc(doc(db, "Users", id));
                fetchApprovedUsers();
                fetchHoldBlockedUsers();
            };

            // Unhold user
            window.unholdUser = async (id) => {
                await updateDoc(doc(db, "Users", id), { status: "approved" });
                fetchHoldBlockedUsers();
                fetchApprovedUsers();
            };

            // Unblock user
            window.unblockUser = async (id) => {
                await updateDoc(doc(db, "Users", id), { status: "approved" });
                fetchHoldBlockedUsers();
                fetchApprovedUsers();
            };

            // Fetch all data
            fetchApprovalRequests();
            fetchOnlineUsers();
            fetchUserLogs();
            fetchApprovedUsers();
            fetchHoldBlockedUsers();

            // Logout functionality
            document.getElementById("logout").addEventListener("click", async () => {
                await signOut(auth);
                window.location.href = "index.html";
            });

            // Check auth state
            onAuthStateChanged(auth, (user) => {
                if (!user) {
                    window.location.href = "index.html";
                }
            });
        });
    </script>
</head>
<body>
    <header style="background-color: green; color: white; padding: 10px; display: flex; justify-content: space-between;">
        <h1>Admin Dashboard</h1>
        <div class="dropdown">
            <button style="background-color: white; border: none; padding: 10px; border-radius: 5px;">Settings</button>
            <div class="dropdown-content">
                <a href="adminprofile.html">Admin Profile</a>
                <a href="#" id="logout">Logout</a>
            </div>
        </div>
    </header>
    <main style="padding: 20px;">
        <div class="section">
            <div class="section-title">
                Approval Requests <span class="badge" id="approval-badge">0</span>
            </div>
            <div class="section-content" id="approval-requests"></div>
        </div>
        <div class="section">
            <div class="section-title">
                Online Users <span class="badge" id="online-badge">0</span>
            </div>
            <div class="section-content" id="online-users"></div>
        </div>
        <div class="section">
            <div class="section-title">
                User Logs <span class="badge" id="logs-badge">0</span>
            </div>
            <div class="section-content" id="user-logs"></div>
        </div>
        <div class="section">
            <div class="section-title">
                Approved Users <span class="badge" id="approved-badge">0</span>
            </div>
            <div class="section-content" id="approved-users"></div>
        </div>
        <div class="section">
            <div class="section-title">
                Hold/Blocked Users <span class="badge" id="hold-blocked-badge">0</span>
            </div>
            <div class="section-content" id="hold-blocked-users"></div>
        </div>
    </main>
</body>
</html>