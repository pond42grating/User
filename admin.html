<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f7faff;
        }

        header {
            background: #4caf50;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
        }

        header h1 {
            margin: 0;
        }

        .settings {
            position: relative;
        }

        #settingsDropdown {
            position: absolute;
            top: 40px;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            padding: 5px;
            list-style: none;
            margin: 0;
            display: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        #settingsDropdown li {
            margin: 5px 0;
            cursor: pointer;
        }

        #settingsDropdown li a {
            text-decoration: none;
            color: black;
        }

        #settingsButton:hover + #settingsDropdown,
        #settingsDropdown:hover {
            display: block;
        }

        section {
            margin: 20px;
            background: white;
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 5px;
        }

        .badge {
            background: red;
            color: white;
            border-radius: 50%;
            padding: 5px 10px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <header>
            <h1>Admin Dashboard</h1>
            <div class="settings">
                <button id="settingsButton">Settings</button>
                <ul id="settingsDropdown" class="hidden">
                    <li><a href="adminprofile.html">Admin Profile</a></li>
                    <li id="logoutButton">Logout</li>
                </ul>
            </div>
        </header>

        <main>
            <section id="approvalRequests">
                <h2>Approval Requests <span id="approvalBadge" class="badge">0</span></h2>
                <div id="approvalList">Loading...</div>
            </section>

            <section id="onlineUsers">
                <h2>Online Users <span id="onlineBadge" class="badge">0</span></h2>
                <div id="onlineList">Loading...</div>
            </section>

            <section id="userLogs">
                <h2>User Logs <span id="logsBadge" class="badge">0</span></h2>
                <div id="logsList">Loading...</div>
            </section>

            <section id="approvedUsers">
                <h2>Approved Users <span id="approvedBadge" class="badge">0</span></h2>
                <div id="approvedList">Loading...</div>
            </section>

            <section id="holdBlockedUsers">
                <h2>Hold/Blocked Users <span id="holdBadge" class="badge">0</span></h2>
                <div id="holdList">Loading...</div>
            </section>
        </main>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAXZgxM6PU-T3D2811KnBszblRWju7rv1Y",
            authDomain: "dws-management.firebaseapp.com",
            projectId: "dws-management",
            storageBucket: "dws-management.firebasestorage.app",
            messagingSenderId: "23827231923",
            appId: "1:23827231923:web:97141b6d19c7cd109d2cc6",
            measurementId: "G-L14GLJDYW7",
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Fetch and update Approval Requests
        function fetchApprovalRequests() {
            db.collection("Users").where("isApproved", "==", false).onSnapshot((snapshot) => {
                const approvalList = document.getElementById("approvalList");
                const approvalBadge = document.getElementById("approvalBadge");
                approvalList.innerHTML = "";
                let count = 0;

                snapshot.forEach((doc) => {
                    count++;
                    const user = doc.data();
                    const div = document.createElement("div");
                    div.innerHTML = `
                        ${user.name} (${user.email})
                        <button onclick="approveUser('${doc.id}')">Approve</button>
                        <button onclick="rejectUser('${doc.id}')">Reject</button>
                    `;
                    approvalList.appendChild(div);
                });

                approvalBadge.textContent = count;
                if (count === 0) {
                    approvalList.innerHTML = "No approval requests found.";
                }
            });
        }

        // Approve user
        function approveUser(userId) {
            db.collection("Users").doc(userId).update({ isApproved: true });
        }

        // Reject user
        function rejectUser(userId) {
            db.collection("Users").doc(userId).delete();
        }

        // Fetch and update Online Users
        function fetchOnlineUsers() {
            db.collection("Users").where("isOnline", "==", true).onSnapshot((snapshot) => {
                const onlineList = document.getElementById("onlineList");
                const onlineBadge = document.getElementById("onlineBadge");
                onlineList.innerHTML = "";
                let count = 0;

                snapshot.forEach((doc) => {
                    count++;
                    const user = doc.data();
                    const onlineTime = getTimeElapsed(user.lastLogin);
                    const div = document.createElement("div");
                    div.textContent = `${user.name} (${user.email}) - Online for ${onlineTime}`;
                    onlineList.appendChild(div);
                });

                onlineBadge.textContent = count;
                if (count === 0) {
                    onlineList.innerHTML = "No users online.";
                }
            });
        }

        // Helper: Get time elapsed
        function getTimeElapsed(timestamp) {
            const loginTime = new Date(timestamp);
            const currentTime = new Date();
            const diff = Math.floor((currentTime - loginTime) / 1000); // in seconds

            const hours = Math.floor(diff / 3600);
            const minutes = Math.floor((diff % 3600) / 60);
            return `${hours} hours ${minutes} minutes`;
        }

        // Initialize
        fetchApprovalRequests();
        fetchOnlineUsers();
    </script>
</body>
</html>